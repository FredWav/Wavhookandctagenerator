<!doctype html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="color-scheme" content="dark light"/>
<title>Analyseur TikTok ‚Äì DEBUG</title>
<style>
  :root {
    --bg: #111111;
    --card-bg: rgba(24, 24, 27, 0.7);
    --card-border: rgba(255, 255, 255, 0.1);
    --ink: #E4E4E7;
    --muted: #A1A1AA;
    --accent: #d946ef;
    --accent-strong: #c026d3;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --radius: 16px;
  }
  
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--ink);
    font-family: system-ui, sans-serif;
    font-size: 15px;
    line-height: 1.6;
  }
  
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  h1 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
    font-weight: 700;
  }
  
  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 1.5rem;
  }
  
  .debug-panel {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    font-family: monospace;
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .debug-log {
    margin: 2px 0;
    padding: 2px 4px;
    border-radius: 3px;
  }
  
  .debug-log.info { background: rgba(59, 130, 246, 0.2); }
  .debug-log.success { background: rgba(16, 185, 129, 0.2); }
  .debug-log.warning { background: rgba(245, 158, 11, 0.2); }
  .debug-log.error { background: rgba(239, 68, 68, 0.2); }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--muted);
  }
  
  input[type="url"] {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--card-border);
    border-radius: 10px;
    background: rgba(0,0,0,0.2);
    color: var(--ink);
    font-size: 15px;
  }
  
  input[type="url"]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.2);
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    background: var(--accent);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn:hover:not(:disabled) {
    background: var(--accent-strong);
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .btn.clear {
    background: var(--warning);
    margin-left: 8px;
  }
  
  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .status {
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 500;
    margin: 8px 0;
  }
  
  .status.info {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
  }
  
  .status.success {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
  }
  
  .status.error {
    background: rgba(239, 68, 68, 0.2);
    color: var(--error);
  }
  
  .results {
    min-height: 100px;
  }
  
  .metric {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--card-border);
  }
  
  .metric:last-child { border-bottom: none; }
  
  .metric-value {
    font-weight: 600;
    color: var(--accent);
  }
  
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }
  
  .stat-card {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent);
  }
  
  .stat-label {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 4px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üîç Analyseur TikTok - Mode DEBUG</h1>
    
    <div class="card">
      <h2>Analyse de vid√©o TikTok</h2>
      
      <label for="videoUrl">URL de la vid√©o TikTok</label>
      <input 
        type="url" 
        id="videoUrl" 
        placeholder="https://www.tiktok.com/@username/video/..."
      />
      
      <div style="margin-top: 1rem;">
        <button id="analyzeBtn" class="btn" onclick="analyzeVideo()">
          <span id="spinner" class="spinner" style="display: none;"></span>
          <span id="btnText">üöÄ Analyser</span>
        </button>
        <button class="btn clear" onclick="clearDebug()">üóëÔ∏è Clear Debug</button>
      </div>
      
      <div id="status"></div>
    </div>
    
    <div class="card">
      <h2>üêõ Console de Debug</h2>
      <div id="debugPanel" class="debug-panel">
        <div class="debug-log info">üîß Analyseur en mode debug - Pr√™t pour les tests</div>
      </div>
    </div>
    
    <div class="card">
      <h2>üìä R√©sultats</h2>
      <div id="results" class="results">
        <p style="color: var(--muted); text-align: center;">Les r√©sultats appara√Ætront ici...</p>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_ENDPOINT = '/api/analyze-video';
    let requestTimeout;
    
    // Fonction de debug avec timestamps
    function debugLog(type, message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const debugPanel = document.getElementById('debugPanel');
      
      const logDiv = document.createElement('div');
      logDiv.className = `debug-log ${type}`;
      logDiv.innerHTML = `[${timestamp}] ${message}`;
      
      if (data) {
        logDiv.innerHTML += `<br>üìä ${JSON.stringify(data, null, 2)}`;
      }
      
      debugPanel.appendChild(logDiv);
      debugPanel.scrollTop = debugPanel.scrollHeight;
      
      // Log aussi dans la console du navigateur
      console.log(`[TikTok Analyzer] ${type.toUpperCase()}: ${message}`, data || '');
    }
    
    // Fonction pour afficher le statut
    function setStatus(type, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    // Fonction pour clear le debug
    function clearDebug() {
      const debugPanel = document.getElementById('debugPanel');
      debugPanel.innerHTML = '<div class="debug-log info">üîß Debug panel cleared</div>';
      document.getElementById('results').innerHTML = '<p style="color: var(--muted); text-align: center;">Les r√©sultats appara√Ætront ici...</p>';
      setStatus('info', 'üîÑ Debug panel et r√©sultats effac√©s');
    }
    
    // Fonction principale d'analyse
    async function analyzeVideo() {
      const startTime = Date.now();
      const url = document.getElementById('videoUrl').value.trim();
      const btn = document.getElementById('analyzeBtn');
      const btnText = document.getElementById('btnText');
      const spinner = document.getElementById('spinner');
      
      debugLog('info', 'üöÄ === D√âBUT ANALYSE ===');
      
      // Validation URL
      if (!url) {
        debugLog('error', '‚ùå URL manquante');
        setStatus('error', 'Veuillez entrer une URL TikTok');
        return;
      }
      
      if (!url.includes('tiktok.com')) {
        debugLog('error', `‚ùå URL invalide: ${url}`);
        setStatus('error', 'URL TikTok invalide');
        return;
      }
      
      debugLog('success', `‚úÖ URL valid√©e: ${url}`);
      
      // Interface en mode loading
      btn.disabled = true;
      spinner.style.display = 'inline-block';
      btnText.textContent = 'Analyse en cours...';
      setStatus('info', 'üîÑ Analyse en cours...');
      
      // Timeout de s√©curit√©
      requestTimeout = setTimeout(() => {
        debugLog('error', '‚è∞ TIMEOUT - La requ√™te a pris plus de 30 secondes');
        setStatus('error', 'Timeout - La requ√™te a pris trop de temps');
        resetUI();
      }, 30000);
      
      try {
        debugLog('info', 'üì° Envoi de la requ√™te vers l\'API');
        
        // Test de connectivit√© basique
        debugLog('info', 'üåê Test de connectivit√©...');
        
        const requestPayload = { url };
        debugLog('info', 'üì¶ Payload de la requ√™te', requestPayload);
        
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestPayload)
        });
        
        const duration = Date.now() - startTime;
        debugLog('info', `üì¨ R√©ponse re√ßue en ${duration}ms - Status: ${response.status}`);
        
        // V√©rification du status HTTP
        if (!response.ok) {
          debugLog('error', `‚ùå Erreur HTTP ${response.status}: ${response.statusText}`);
          
          let errorData;
          try {
            errorData = await response.json();
            debugLog('error', 'üìÑ D√©tails de l\'erreur', errorData);
          } catch (e) {
            const errorText = await response.text();
            debugLog('error', `üìÑ R√©ponse brute: ${errorText}`);
          }
          
          throw new Error(`Erreur ${response.status}: ${errorData?.error || response.statusText}`);
        }
        
        // Parsing de la r√©ponse
        debugLog('info', 'üìã Parsing de la r√©ponse JSON...');
        const data = await response.json();
        
        debugLog('success', '‚úÖ R√©ponse pars√©e avec succ√®s', {
          success: data.success,
          hasStats: !!data.stats,
          hasVideo: !!data.video,
          analysisId: data.analysisId
        });
        
        if (!data.success) {
          throw new Error(data.error || 'L\'analyse a √©chou√©');
        }
        
        // Affichage des r√©sultats
        displayResults(data);
        setStatus('success', `‚úÖ Analyse termin√©e en ${duration}ms`);
        
      } catch (error) {
        const duration = Date.now() - startTime;
        debugLog('error', `‚ùå ERREUR apr√®s ${duration}ms: ${error.message}`);
        
        // Gestion des erreurs sp√©cifiques
        let errorMessage = error.message;
        if (error.message.includes('Failed to fetch')) {
          errorMessage = 'üåê Impossible de contacter l\'API - V√©rifiez votre connexion';
          debugLog('error', 'üåê Probl√®me de connectivit√© r√©seau d√©tect√©');
        } else if (error.message.includes('404')) {
          errorMessage = 'üîç Vid√©o TikTok introuvable - V√©rifiez l\'URL';
        } else if (error.message.includes('403')) {
          errorMessage = 'üö´ Acc√®s interdit - Vid√©o priv√©e ou g√©o-restreinte';
        } else if (error.message.includes('500')) {
          errorMessage = '‚öôÔ∏è Erreur serveur - R√©essayez dans quelques instants';
        }
        
        setStatus('error', errorMessage);
        document.getElementById('results').innerHTML = `
          <div class="status error">
            <strong>‚ùå Erreur d'analyse</strong><br>
            ${errorMessage}<br><br>
            <small>üí° Consultez la console de debug pour plus de d√©tails</small>
          </div>
        `;
        
      } finally {
        clearTimeout(requestTimeout);
        resetUI();
        
        const totalDuration = Date.now() - startTime;
        debugLog('info', `üèÅ Analyse termin√©e - Dur√©e totale: ${totalDuration}ms`);
      }
    }
    
    // Fonction pour reset l'interface
    function resetUI() {
      const btn = document.getElementById('analyzeBtn');
      const btnText = document.getElementById('btnText');
      const spinner = document.getElementById('spinner');
      
      btn.disabled = false;
      spinner.style.display = 'none';
      btnText.textContent = 'üöÄ Analyser';
    }
    
    // Fonction pour afficher les r√©sultats
    function displayResults(data) {
      debugLog('info', 'üé® G√©n√©ration de l\'affichage des r√©sultats');
      
      const { video, stats, metrics, analysis, debug } = data;
      
      let html = '<div>';
      
      // Infos debug de l'API
      if (debug) {
        html += `
          <div class="status info">
            üìä <strong>Infos Debug API:</strong><br>
            ‚è±Ô∏è Dur√©e: ${debug.duration}<br>
            üì° oEmbed: ${debug.hasOembedData ? '‚úÖ' : '‚ùå'}<br>
            üï∑Ô∏è ScrapingBee: ${debug.hasScrapingData ? '‚úÖ' : '‚ùå'}<br>
            üìà Stats: ${debug.hasStats ? '‚úÖ' : '‚ùå'}
          </div>
        `;
      }
      
      // Infos vid√©o
      html += '<h3>üìπ Informations Vid√©o</h3>';
      html += `<div class="metric"><span>URL:</span><span style="font-size: 0.8em; word-break: break-all;">${video.url}</span></div>`;
      html += `<div class="metric"><span>Description:</span><span>"${video.description || 'N/A'}"</span></div>`;
      if (video.author) html += `<div class="metric"><span>Auteur:</span><span>@${video.author}</span></div>`;
      if (video.thumbnail) html += `<div style="text-align: center; margin: 1rem 0;"><img src="${video.thumbnail}" alt="Miniature" style="max-width: 200px; border-radius: 8px;"></div>`;
      
      // Stats et m√©triques
      if (stats) {
        html += '<h3>üìä Statistiques</h3>';
        html += '<div class="grid">';
        html += `<div class="stat-card"><div class="stat-value">${stats.formatted?.views || stats.views.toLocaleString()}</div><div class="stat-label">Vues</div></div>`;
        html += `<div class="stat-card"><div class="stat-value">${stats.formatted?.likes || stats.likes.toLocaleString()}</div><div class="stat-label">J'aime</div></div>`;
        html += `<div class="stat-card"><div class="stat-value">${stats.formatted?.comments || stats.comments.toLocaleString()}</div><div class="stat-label">Commentaires</div></div>`;
        html += `<div class="stat-card"><div class="stat-value">${stats.formatted?.shares || stats.shares.toLocaleString()}</div><div class="stat-label">Partages</div></div>`;
        html += '</div>';
        
        html += '<h3>üìà M√©triques</h3>';
        html += `<div class="metric"><span>Taux d'engagement:</span><span class="metric-value">${metrics.engagementRate.toFixed(2)}%</span></div>`;
        html += `<div class="metric"><span>Engagements totaux:</span><span class="metric-value">${metrics.totalEngagements.toLocaleString()}</span></div>`;
        html += `<div class="metric"><span>Score viral:</span><span class="metric-value">${metrics.viralityScore}/100</span></div>`;
      }
      
      // Analyse
      if (analysis) {
        html += '<h3>üéØ Analyse</h3>';
        html += `<div class="metric"><span>Score global:</span><span class="metric-value">${analysis.score}/100</span></div>`;
        html += `<div class="metric"><span>Potentiel viral:</span><span class="metric-value">${analysis.potentiel_viral.toUpperCase()}</span></div>`;
      }
      
      html += '</div>';
      
      document.getElementById('results').innerHTML = html;
      debugLog('success', '‚úÖ R√©sultats affich√©s avec succ√®s');
    }
    
    // √âv√©nements
    document.getElementById('videoUrl').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        analyzeVideo();
      }
    });
    
    // Log d'initialisation
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('success', 'üöÄ Analyseur TikTok DEBUG initialis√©');
      debugLog('info', `üì° API Endpoint: ${API_ENDPOINT}`);
      
      // Test de base de l'API
      debugLog('info', 'üîç Test de connectivit√© API...');
      fetch('/api/analyze-video', { method: 'OPTIONS' })
        .then(response => {
          debugLog('success', `‚úÖ API accessible - Status: ${response.status}`);
        })
        .catch(error => {
          debugLog('error', `‚ùå API non accessible: ${error.message}`);
        });
    });
  </script>
</body>
</html>
