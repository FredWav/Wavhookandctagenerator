// api/generate-ctas.js - Version Corrig√©e - GPT-4o
const express = require('express');
const router = express.Router();

const OPENAI_URL = "https://api.openai.com/v1/chat/completions";
const MODEL = "gpt-4o";

// CTAs g√©n√©riques √† √©viter absolument
const FORBIDDEN_PATTERNS = [
    "N'oubliez pas de", "Pensez √†", "Cliquez sur", "Suivez-moi", 
    "Abonne-toi si", "Laisse un commentaire si", "Like si"
];

function corsHeaders(res) {
    const origin = process.env.CORS_ORIGIN || "*";
    res.set({
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": origin,
        "Access-Control-Allow-Methods": "POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization"
    });
}

router.options('/', (req, res) => {
    corsHeaders(res);
    res.json({ ok: true });
});

router.post('/', async (req, res) => {
    corsHeaders(res);
    
    try {
        const { 
            intent = "follow", 
            platform = "tiktok", 
            tone = "direct",
            constraints = "", 
            count = 20, 
            putaclic = false 
        } = req.body;

        const max = 50;
        const safeCount = Math.min(Math.max(1, count | 0), max);
        
        // SP√âCIFICATIONS PLATEFORMES
        const platformSpecs = {
            tiktok: {
                psychology: "Action imm√©diate, FOMO, appartenance communaut√©. R√©flexe instantan√©.",
                language_style: "Tr√®s direct, familier, verbes d'action forts. 'Rejoins', 'Chope', 'Teste'.",
                best_practice: "Int√©grer dans les 2 derni√®res secondes, souvent li√© √† un trend."
            },
            reels: {
                psychology: "Inspiration, utilit√©, sauvegarde pour plus tard. Valeur ajout√©e.",
                language_style: "Aspirationnel et doux. 'Enregistre ce post', 'Partage √† un ami'.",
                best_practice: "CTA esth√©tique et bien int√©gr√©, overlay discret."
            },
            shorts: {
                psychology: "Curiosit√©, binge-watching, abonnement pour ne rien rater. Cr√©er une boucle.",
                language_style: "Clair, concis, orient√© b√©n√©fice. 'Abonne-toi pour la partie 2'.",
                best_practice: "CTA tr√®s court qui incite √† regarder la suite."
            }
        };

        // SP√âCIFICATIONS INTENTIONS (SYNCHRONIS√âES AVEC LE FRONT)
        const intentSpecs = {
            follow: {
                goal: "Convertir un spectateur en abonn√©.",
                trigger: "Promesse de valeur future claire et imm√©diate.",
                structure: "Abonne-toi pour [B√âN√âFICE CONCRET]"
            },
            comment: {
                goal: "G√©n√©rer engagement et d√©bat.",
                trigger: "Question ouverte, prise de position, validation sociale.",
                structure: "Dis-moi en commentaire [QUESTION SIMPLE]"
            },
            click: {
                goal: "Diriger le trafic vers une ressource externe.",
                trigger: "Urgence, exclusivit√©, solution √† un probl√®me.",
                structure: "Le lien en bio pour [R√âSULTAT CONCRET]"
            },
            save: {
                goal: "Augmenter le replay value et la consid√©ration.",
                trigger: "Utilit√©, gain de temps, peur de perdre une info pr√©cieuse.",
                structure: "Enregistre ce post pour [UTILIT√â FUTURE]"
            },
            dm: {
                goal: "G√©n√©rer des messages priv√©s pour conversion.",
                trigger: "Personnalisation, exclusivit√©, aide individuelle.",
                structure: "√âcris-moi en DM pour [AIDE PERSONNALIS√âE]"
            },
            optin: {
                goal: "Collecter des emails pour nurturing.",
                trigger: "Valeur exclusive, formation gratuite, ressource premium.",
                structure: "Email en bio pour recevoir [RESSOURCE EXCLUSIVE]"
            }
        };

        const currentPlatform = platformSpecs[platform] || platformSpecs.tiktok;
        const currentIntent = intentSpecs[intent] || intentSpecs.follow;

        // R√âSOLUTION DES OPTIONS
        const resolveOptions = () => {
            let intensity = "normale";
            let mode = "balanced";
            let temperature = 0.8; // CORRIG√â: Augment√© de 0.7 √† 0.8

            if (putaclic) {
                mode = "putaclic_extreme";
                intensity = "maximale";
                temperature = 0.95; // CORRIG√â: Augment√© de 0.9 √† 0.95
            }
            return { mode, intensity, temperature };
        };

        const { mode: resolvedMode, intensity, temperature } = resolveOptions();

        // SYSTEM PROMPT OPTIMIS√â
        const systemPrompt = `Tu es une experte en copywriting et marketing de conversion. Ta mission est de cr√©er des Call-to-Actions (CTAs) irr√©sistibles.

EXPERTISE FONCTIONNELLE:
- Objectif du CTA (${intent}): ${currentIntent.goal}
- Levier psychologique: ${currentIntent.trigger}
- Structure recommand√©e: ${currentIntent.structure}

EXPERTISE PLATEFORME (${platform.toUpperCase()}):
- Psychologie audience: ${currentPlatform.psychology}
- Style linguistique: ${currentPlatform.language_style}
- Best practice: ${currentPlatform.best_practice}

R√àGLES SYST√àME ABSOLUES:
- G√©n√®re UNIQUEMENT du JSON valide, aucun texte hors JSON
- Tous les CTAs en fran√ßais, 3-8 mots MAXIMUM
- Chaque CTA doit √™tre percutant et actionnable
- Format de sortie strict respect√©`;

        // USER PROMPT INTENSIFI√â
        let userPrompt = `MISSION (Intensit√© ${intensity.toUpperCase()}): Cr√©er ${safeCount} CTAs ultra-efficaces.

CONTEXTE:
- Plateforme: ${platform}
- Intention: ${intent}
- Ton: ${tone}
- Contraintes: ${constraints || "Aucune"}

${putaclic ? `
üî• PUTACLIC EXTR√äME - MODE BRUTAL ACTIV√â:
‚Ä¢ VIOLENCE √âMOTIONNELLE: 'FAIS-LE MAINTENANT', 'DERNI√àRE CHANCE', 'URGENT'
‚Ä¢ MOTS CHOCS OBLIGATOIRES: 'CRITIQUE', 'VITAL', 'MAINTENANT OU JAMAIS'
‚Ä¢ AUTORIT√â BRUTALE: Ordonne directement, aucune politesse, imp√©ratif sec
‚Ä¢ URGENCE DRAMATIQUE: 'Avant qu'il soit trop tard', 'Plus que 24h'
‚Ä¢ FOMO EXTR√äME: 'Derni√®re place', 'Offre expire', 'Ne rate pas √ßa'
‚Ä¢ AUCUNE NUANCE: Sois DIRECTIF, AUTORITAIRE, SANS COMPROMIS
` : `
üéØ MODE √âQUILIBR√â (Impact contr√¥l√©):
‚Ä¢ B√âN√âFICE CLAIR: Le gain pour l'utilisateur doit √™tre √©vident
‚Ä¢ ACTION SIMPLE: Une seule action, facile √† r√©aliser
‚Ä¢ INSPIRANT: Donne envie de passer √† l'action
‚Ä¢ CR√âDIBLE: Promesses r√©alistes et atteignables
`}

SP√âCIFICATIONS TECHNIQUES:
- Longueur: 3-8 mots MAXIMUM (CORRIG√â: plus strict)
- Structure: [VERBE D'ACTION] pour [B√âN√âFICE UTILISATEUR]
- Interdictions: Jamais "${FORBIDDEN_PATTERNS.slice(0, 4).join('", "')}"
- Originalit√©: Chaque CTA unique et m√©morable
- Impact: √âmotion imm√©diate dans les 2 premiers mots

RETOURNE EXACTEMENT:
{
  "ctas": ["cta1", "cta2", ...]
}`;

        // G√âN√âRATION AVEC RETRY INTELLIGENT
        const generate = async (prompt, temp) => {
            return await fetch(OPENAI_URL, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: MODEL,
                    temperature: temp,
                    top_p: 0.9,
                    frequency_penalty: 0.3,
                    presence_penalty: 0.1,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: prompt }
                    ],
                    response_format: { type: "json_object" }
                })
            });
        };

        // Premi√®re tentative
        let response = await generate(userPrompt, temperature);

        if (!response.ok) {
            const errorText = await response.text().catch(() => "");
            console.error("OpenAI API Error:", errorText);
            return res.status(500).json({ error: "OpenAI error", details: errorText });
        }

        let data = await response.json();
        let parsed;
        try {
            parsed = JSON.parse(data.choices?.[0]?.message?.content || "{}");
        } catch {
            parsed = { ctas: [] };
        }

        let initialCtas = Array.isArray(parsed.ctas) ? parsed.ctas : [];
        
        // VALIDATION STRICTE (CORRIG√âE)
        const validatedCtas = initialCtas.filter(cta => {
            if (typeof cta !== 'string') return false;
            const wordCount = cta.trim().split(/\s+/).length;
            const hasForbiddenPattern = FORBIDDEN_PATTERNS.some(p => 
                cta.toLowerCase().includes(p.toLowerCase())
            );
            // CORRIG√â: 3-8 mots au lieu de 5-15
            return wordCount >= 3 && wordCount <= 8 && !hasForbiddenPattern;
        });

        // SYST√àME DE RETRY AM√âLIOR√â
        const qualityThreshold = Math.floor(safeCount * (putaclic ? 0.5 : 0.7));
        if (validatedCtas.length < qualityThreshold && safeCount >= 10) {
            console.log(`Qualit√© insuffisante (${validatedCtas.length}/${safeCount}), retry...`);

            const retryBoost = putaclic ? `
üî• RETRY PUTACLIC ULTRA-BRUTAL: La g√©n√©ration pr√©c√©dente n'√©tait PAS ASSEZ VIOLENTE.
‚Ä¢ TRIPLE l'intensit√© √©motionnelle
‚Ä¢ Utilise des mots encore plus CHOQUANTS et AUTORITAIRES  
‚Ä¢ Cr√©e plus de PEUR et d'URGENCE DRAMATIQUE
‚Ä¢ Sois encore plus BRUTAL et DIRECTIF dans tes ordres
‚Ä¢ AUCUNE POLITESSE: Commande, n'invite pas
` : `
üéØ RETRY CR√âATIVIT√â MAXIMALE: La g√©n√©ration pr√©c√©dente √©tait trop g√©n√©rique.
‚Ä¢ SOIS PLUS CR√âATIF: √âvite les formulations basiques
‚Ä¢ CONCENTRE-TOI SUR LE B√âN√âFICE: 'Qu'est-ce que j'y gagne ?'
‚Ä¢ RESPECTE 3-8 mots: Concision maximale
‚Ä¢ DOUBLE l'originalit√© et l'impact √©motionnel
`;
            
            const retryPrompt = userPrompt + retryBoost;
            const retryResponse = await generate(retryPrompt, Math.min(temperature + 0.1, 1.0));

            if (retryResponse.ok) {
                const retryData = await retryResponse.json();
                try {
                    const retryParsed = JSON.parse(retryData.choices?.[0]?.message?.content || "{}");
                    const retryCtas = Array.isArray(retryParsed.ctas) ? retryParsed.ctas : [];
                    
                    const retryValidated = retryCtas.filter(cta => {
                        if (typeof cta !== 'string') return false;
                        const wordCount = cta.trim().split(/\s+/).length;
                        const hasForbiddenPattern = FORBIDDEN_PATTERNS.some(p => 
                            cta.toLowerCase().includes(p.toLowerCase())
                        );
                        return wordCount >= 3 && wordCount <= 8 && !hasForbiddenPattern;
                    });

                    if (retryValidated.length > validatedCtas.length) {
                        console.log("Retry r√©ussi, nouveaux CTAs utilis√©s");
                        parsed.ctas = retryValidated;
                    }
                } catch (e) {
                    console.log('Retry parsing failed, keeping original');
                }
            }
        }
        
        // FINALISATION
        let finalCtas = Array.isArray(parsed.ctas) ? parsed.ctas : [];
        finalCtas = finalCtas.filter(cta => {
            if (typeof cta !== 'string') return false;
            const wordCount = cta.trim().split(/\s+/).length;
            return wordCount >= 3 && wordCount <= 8;
        });

        res.json({
            ctas: finalCtas.slice(0, safeCount),
            metadata: {
                platform,
                intent,
                tone,
                mode: resolvedMode,
                intensity,
                requested_count: safeCount,
                generated_count: initialCtas.length,
                validated_count: finalCtas.length,
                quality_score: Math.round((finalCtas.length / Math.max(initialCtas.length, 1)) * 100),
                temperature_used: temperature,
                timestamp: new Date().toISOString()
            }
        });

    } catch (error) {
        console.error('Generate CTAs error:', error);
        res.status(500).json({ error: 'Erreur serveur', details: error.message });
    }
});

module.exports = router;
